name: Build and Release

on:
  push:
    tags:
      - '*'
  workflow_dispatch:

permissions:
  contents: write
  actions: read

jobs:
  build-mac:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        
    - name: Make scripts executable
      run: |
        chmod +x setup_dependencies.sh
        chmod +x build_app_mac.sh
        chmod +x build_jre_mac.sh
        chmod +x papi-converter.sh
        
    - name: Setup dependencies
      run: ./setup_dependencies.sh
      
    - name: Build application
      run: ./build_app_mac.sh
      
    - name: Clean JRE directory
      run: rm -rf jre-mac
      
    - name: Create JRE
      run: ./build_jre_mac.sh
      
    - name: Package distribution
      run: |
        mkdir -p release/papi-converter-mac
        cp -r dist/* release/papi-converter-mac/
        cp -r jre-mac release/papi-converter-mac/jre || true
        cp papi-converter.sh release/papi-converter-mac/
        chmod +x release/papi-converter-mac/papi-converter.sh
        cd release && tar -czf papi-converter-mac.tar.gz papi-converter-mac
        
    - name: Upload Mac artifact
      uses: actions/upload-artifact@v4
      with:
        name: papi-converter-mac
        path: release/papi-converter-mac.tar.gz

  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        
    - name: Setup dependencies
      run: .\setup_dependencies.bat
      shell: cmd
      
    - name: Build application
      run: .\build_app_win.bat
      shell: cmd
      
    - name: Clean JRE directory
      run: if exist jre-win rmdir /s /q jre-win
      shell: cmd
      
    - name: Create JRE
      run: .\build_jre_win.bat
      shell: cmd
      
    - name: Package distribution
      run: |
        mkdir release\papi-converter-windows
        xcopy dist\* release\papi-converter-windows\ /E /I
        if exist jre-win xcopy jre-win release\papi-converter-windows\jre\ /E /I
        copy papi-converter.bat release\papi-converter-windows\
        cd release && 7z a papi-converter-windows.zip papi-converter-windows
      shell: cmd
      
    - name: Upload Windows artifact
      uses: actions/upload-artifact@v4
      with:
        name: papi-converter-windows
        path: release/papi-converter-windows.zip

  release:
    runs-on: ubuntu-latest
    needs: [build-mac, build-windows]
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Download Mac artifact
      uses: actions/download-artifact@v4
      with:
        name: papi-converter-mac
        
    - name: Download Windows artifact
      uses: actions/download-artifact@v4
      with:
        name: papi-converter-windows
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          papi-converter-mac.tar.gz
          papi-converter-windows.zip
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

